<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Paint por N√∫meros</title>
  <style>
    body { 
      font-family: Arial, Comics Sans; 
      background: #f4f6f8; 
      margin: 0; 
      display: flex; 
      height: 100vh;
    }
    #sidebar {
      width: 240px;
      background: #fff;
      border-right: 2px solid #ccc;
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #gallery {
      width: 200px;
      background: #fff;
      border-left: 2px solid #ccc;
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
      text-align: center;
    }
    #main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    h1 { font-size: 20px; margin-bottom: 15px; text-align: center; }
    #controls { margin-bottom: 20px; text-align: center; }
    #controls button, #controls input {
      display: block;
      margin: 8px auto;
      padding: 6px 10px;
      cursor: pointer;
      border: none;
      background: #4a90e2;
      color: white;
      border-radius: 4px;
      font-size: 14px;
    }
    #controls button:hover { background: #357ABD; }
    #palette { 
      display: grid; 
      grid-template-columns: repeat(5, 1fr); 
      gap: 5px; 
      justify-items: center;
    }
    #palette button { 
      width: 28px; 
      height: 28px; 
      border: 2px solid #222; 
      cursor: pointer; 
    }
    #selectedColor {
      margin-top: 15px; 
      text-align: center; 
      font-weight: bold; 
    }
    #selectedColor span {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 1px solid #000;
      vertical-align: middle;
    }
    #canvas { 
      border: 2px solid #333; 
      background: #fff; 
      cursor: crosshair; 
      max-width: 100%;
    }
    .thumb {
      width: 100%;
      margin: 10px 0;
      border: 2px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s, border 0.2s;
    }
    .thumb:hover {
      transform: scale(1.05);
      border: 2px solid #4a90e2;
    }
    .thumb.disabled {
      opacity: 0.35;
      pointer-events: none;
    }
    #shareLink {
      margin-top: 10px;
      font-size: 13px;
      color: green;
      word-break: break-all;
    }
    #copyMsg {
      color: #006400;
      font-weight: bold;
      margin-top: 6px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>Paint por N√∫meros</h1>

    <div id="controls">
      <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.svg" />
      <button onclick="resetCanvas()">üîÑ Limpiar</button>
      <button onclick="undo()">‚Ü©Ô∏è Deshacer</button>
      <button onclick="downloadImage()">‚¨áÔ∏è Descargar</button>
    </div>

    <h3>üé® Paleta</h3>
    <div id="palette"></div>
    <div id="selectedColor">Color actual: <span id="colorBox"></span></div>

    <div id="shareLink"></div>
    <div id="copyMsg">‚úÖ Link copiado al portapapeles</div>
  </div>

  <div id="main">
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>

  <div id="gallery">
    <h3>Elige una imagen</h3>
    <img src="https://i.imgur.com/9zGQZ5K.png" class="thumb" onclick="selectImage(this)">
    <img src="https://i.imgur.com/lKJiT77.png" class="thumb" onclick="selectImage(this)">
    <img src="https://i.imgur.com/0DElr0H.png" class="thumb" onclick="selectImage(this)">
  </div>

<script>
/* ---------- Config (igual que tu c√≥digo) ---------- */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let currentColor = 'red';
let currentImage = null; 
let originalImage = null;
const colorBox = document.getElementById('colorBox');
let history = []; 
const MAX_HISTORY = 10;
let imageSelected = false;

const colors = [
  'red','crimson','firebrick','salmon','lightcoral',
  'orange','darkorange','coral','tomato','chocolate',
  'gold','yellow','khaki','lightyellow','beige',
  'lime','green','darkgreen','seagreen','olive',
  'cyan','skyblue','deepskyblue','blue','navy',
  'violet','orchid','plum','purple','indigo',
  'pink','hotpink','deeppink','palevioletred','magenta',
  'brown','sienna','peru','gray','dimgray',
  'black','white','silver','lightgray'
];

const palette = document.getElementById('palette');
colorBox.style.background = currentColor;
colors.forEach(c => {
  const btn = document.createElement('button');
  btn.style.background = c;
  btn.title = c;
  btn.onclick = () => {
    currentColor = c;
    colorBox.style.background = c;
  };
  palette.appendChild(btn);
});

/* ---------- Historial ---------- */
function saveState() {
  if (history.length >= MAX_HISTORY) history.shift(); 
  history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
}

function undo() {
  if (history.length > 0) {
    const prev = history.pop();
    ctx.putImageData(prev, 0, 0);
  }
}

/* ---------- Archivo local (igual) ---------- */
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    const img = new Image();
    img.onload = () => { drawBaseImage(img); };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

/* ---------- Funciones nuevas: convert to dataURL con fallback ---------- */
function convertToDataURL(src) {
  // intenta cargar con crossOrigin y convertir a dataURL
  return new Promise((resolve, reject) => {
    try {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        try {
          const c = document.createElement('canvas');
          c.width = img.naturalWidth || img.width;
          c.height = img.naturalHeight || img.height;
          const cctx = c.getContext('2d');
          cctx.drawImage(img, 0, 0);
          const dataURL = c.toDataURL('image/png');
          resolve(dataURL);
        } catch (err) {
          // may be tainted or other error
          reject(err);
        }
      };
      img.onerror = (e) => {
        reject(new Error('No se pudo cargar la imagen para convertir (CORS?)'));
      };
      img.src = src;
      // si ya est√° en cache y no dispara onload, forzar
    } catch (err) {
      reject(err);
    }
  });
}

/* ---------- Selecci√≥n desde galer√≠a (solo 1 vez) ---------- */
async function selectImage(el){
  if (imageSelected) return; // solo permite 1 vez
  try {
    // cargar en canvas
    loadGalleryImage(el.src);

    // deshabilitar las dem√°s miniaturas
    const all = document.querySelectorAll('.thumb');
    all.forEach(img => {
      if (img !== el) {
        img.classList.add("disabled");
      } else {
        img.style.borderColor = "green";
      }
    });

    // intentar obtener dataURL (para compartir sin depender de CORS)
    let finalLink;
    try {
      const dataUrl = await convertToDataURL(el.src); // puede fallar por CORS
      finalLink = window.location.origin + window.location.pathname + "?img=" + encodeURIComponent(dataUrl);
      console.log("Se gener√≥ link con data URL (embed):", finalLink);
    } catch (err) {
      // fallback: usar la URL original (no garantizado que funcione si la otra persona necesita manipular canvas)
      finalLink = window.location.origin + window.location.pathname + "?img=" + encodeURIComponent(el.src);
      console.warn("No se pudo convertir a dataURL (posible CORS). Se gener√≥ link con la URL original:", err);
    }

    // mostrar link en la UI
    const shareBox = document.getElementById("shareLink");
    shareBox.innerHTML = "üîó Link para compartir:<br><a href='" + finalLink + "' target='_blank'>" + finalLink + "</a>";

    // copiar al portapapeles si es posible
    try {
      await navigator.clipboard.writeText(finalLink);
      const msg = document.getElementById("copyMsg");
      msg.style.display = "block";
      setTimeout(()=> msg.style.display = "none", 3000);
    } catch (err) {
      console.warn("No se pudo copiar al portapapeles:", err);
      // no cr√≠tico: seguimos adelante
    }

    imageSelected = true;
  } catch (err) {
    console.error("Error en selectImage:", err);
    alert("Ocurri√≥ un error al seleccionar la imagen. Abre la consola (F12) y pega el error para que lo revise.");
  }
}

/* ---------- Carga desde galer√≠a (igual, con crossOrigin) ---------- */
function loadGalleryImage(src){
  const img = new Image();
  img.crossOrigin = "anonymous"; 
  img.onload = () => { drawBaseImage(img); };
  img.onerror = (e) => {
    console.error("Error cargando imagen de galer√≠a:", e);
    alert("No se pudo cargar la imagen de la galer√≠a (revisa consola).");
  };
  img.src = src;
}

function drawBaseImage(img){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  originalImage = img;
  saveState();
}

/* ---------- Pintar (igual) ---------- */
canvas.addEventListener('click', e => {
  if (!originalImage) return; 
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor(e.clientX - rect.left);
  const y = Math.floor(e.clientY - rect.top);
  saveState();
  floodFill(x, y, currentColor, 40); 
});

function floodFill(startX, startY, fillColor, tolerance = 40) {
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  const i = (startY * canvas.width + startX) * 4;
  const targetColor = [data[i], data[i+1], data[i+2], data[i+3]];
  const [fr, fg, fb, fa] = colorToRGBA(fillColor);
  const visited = new Uint8Array(canvas.width * canvas.height);
  const stack = [[startX, startY]];

  while (stack.length) {
    const [x, y] = stack.pop();
    if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
    const idx = (y * canvas.width + x) * 4;
    const vidx = y * canvas.width + x;
    if (visited[vidx]) continue;
    visited[vidx] = 1;
    const r = data[idx], g = data[idx+1], b = data[idx+2], a = data[idx+3];

    if (colorsClose(r, g, b, a, ...targetColor, tolerance)) {
      data[idx] = fr; data[idx+1] = fg; data[idx+2] = fb; data[idx+3] = fa;
      stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
    }
  }
  ctx.putImageData(imageData, 0, 0);
}

function colorsClose(r1,g1,b1,a1, r2,g2,b2,a2, tolerance) {
  return (Math.abs(r1-r2)<=tolerance &&
          Math.abs(g1-g2)<=tolerance &&
          Math.abs(b1-b2)<=tolerance);
}

function colorToRGBA(color) {
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = 1; tempCanvas.height = 1;
  const tempCtx = tempCanvas.getContext('2d');
  tempCtx.fillStyle = color;
  tempCtx.fillRect(0, 0, 1, 1);
  return [...tempCtx.getImageData(0,0,1,1).data];
}

/* ---------- Reset / Descargar (igual) ---------- */
function resetCanvas(){
  if (originalImage){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
    history = [];
    saveState();
  } else {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    history = [];
  }
}

function downloadImage(){
  const link = document.createElement('a');
  link.download = 'pintado.png';
  link.href = canvas.toDataURL();
  link.click();
}

/* ---------- Cargar desde link compartido (param ?img=) ---------- */
const params = new URLSearchParams(window.location.search);
if (params.has("img")){
  const imgParam = params.get("img");
  try {
    // si es data:/* lo cargamos directo
    if (imgParam.startsWith('data:')) {
      const img = new Image();
      img.onload = () => { drawBaseImage(img); imageSelected = true; disableGalleryThumbs(); };
      img.src = imgParam;
    } else {
      // puede ser una URL o una data encoded; intentamos cargar con crossOrigin
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => { drawBaseImage(img); imageSelected = true; disableGalleryThumbs(); };
      img.onerror = (e) => {
        console.warn("No se pudo cargar imagen desde param (posible CORS). Intentando sin crossOrigin.");
        const img2 = new Image();
        img2.onload = () => { drawBaseImage(img2); imageSelected = true; disableGalleryThumbs(); };
        img2.onerror = () => console.error("No se pudo cargar la imagen desde el par√°metro img.");
        img2.src = imgParam;
      };
      img.src = imgParam;
    }
  } catch (err) {
    console.error("Error al procesar par√°metro img:", err);
  }
}

function disableGalleryThumbs(){
  const all = document.querySelectorAll('.thumb');
  all.forEach(img => {
    img.classList.add('disabled');
  });
}
</script>
</body>
</html>
