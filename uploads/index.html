<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Paint Alan</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      margin: 0;
      padding: 0;
      background: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    #sidebar {
      width: 200px;
      padding: 10px;
      background: #fff;
      border-left: 2px solid #ccc;
    }
    #sidebar h3 {
      text-align: center;
    }
    #imagesContainer img {
      width: 100%;
      margin-bottom: 10px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    #imagesContainer img.selected {
      border: 2px solid green;
    }
    #main {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 1px solid black;
      cursor: crosshair;
    }
    #controls {
      margin-bottom: 10px;
    }
    button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
    input[type="color"] {
      margin: 5px;
    }
    #linkOutput {
      margin-top: 10px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="main">
    <div id="controls">
      <input type="file" id="fileInput" accept="image/*" multiple>
      <input type="color" id="colorPicker" value="#ff0000">
      <button id="clearBtn">Limpiar</button>
      <button id="generateLink">Generar Link</button>
    </div>
    <canvas id="canvas" width="500" height="500"></canvas>
    <input type="text" id="linkOutput" readonly placeholder="Aquí aparecerá el link para compartir">
  </div>
  <div id="sidebar">
    <h3>Elige una imagen</h3>
    <div id="imagesContainer"></div>
  </div>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const colorPicker = document.getElementById("colorPicker");
    const clearBtn = document.getElementById("clearBtn");
    const fileInput = document.getElementById("fileInput");
    const imagesContainer = document.getElementById("imagesContainer");
    const generateLinkBtn = document.getElementById("generateLink");
    const linkOutput = document.getElementById("linkOutput");

    let selectedColor = colorPicker.value;
    let originalImage = null;
    let selectedImgIndex = null;
    let loadedImages = [];

    // 🎨 Cambio de color
    colorPicker.addEventListener("change", e => {
      selectedColor = e.target.value;
    });

    // 📂 Cargar hasta 3 imágenes
    fileInput.addEventListener("change", e => {
      const files = Array.from(e.target.files).slice(0, 3);
      loadedImages = [];
      imagesContainer.innerHTML = "";
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = evt => {
          const img = new Image();
          img.src = evt.target.result;
          img.onload = () => {
            loadedImages.push(img);
            const imgElement = document.createElement("img");
            imgElement.src = img.src;
            imgElement.dataset.index = index;
            imgElement.addEventListener("click", () => selectImage(index));
            imagesContainer.appendChild(imgElement);
          };
        };
        reader.readAsDataURL(file);
      });
    });

    // 📌 Seleccionar imagen lateral
    function selectImage(index) {
      if (selectedImgIndex !== null) return; // solo una vez
      selectedImgIndex = index;
      imagesContainer.querySelectorAll("img").forEach((img, i) => {
        if (i === index) {
          img.classList.add("selected");
        } else {
          img.style.pointerEvents = "none";
          img.style.opacity = "0.5";
        }
      });
      drawImage(loadedImages[index]);
    }

    // 🖼️ Dibujar imagen en canvas
    function drawImage(img) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      originalImage = ctx.getImageData(0, 0, canvas.width, canvas.height);
    }

    // 🎨 Pintar con bote de pintura (flood fill)
    canvas.addEventListener("click", e => {
      if (!originalImage) return;
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor(e.clientX - rect.left);
      const y = Math.floor(e.clientY - rect.top);
      floodFill(x, y, hexToRgba(selectedColor));
    });

    function hexToRgba(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return [
        (bigint >> 16) & 255,
        (bigint >> 8) & 255,
        bigint & 255,
        255
      ];
    }

    function floodFill(x, y, fillColor) {
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;

      const startIdx = (y * canvas.width + x) * 4;
      const startColor = data.slice(startIdx, startIdx + 4);

      if (colorsMatch(startColor, fillColor)) return;

      const stack = [[x, y]];
      while (stack.length) {
        const [cx, cy] = stack.pop();
        const idx = (cy * canvas.width + cx) * 4;

        if (matchStartColor(idx, startColor, data)) {
          data[idx] = fillColor[0];
          data[idx + 1] = fillColor[1];
          data[idx + 2] = fillColor[2];
          data[idx + 3] = 255;

          if (cx > 0) stack.push([cx - 1, cy]);
          if (cx < canvas.width - 1) stack.push([cx + 1, cy]);
          if (cy > 0) stack.push([cx, cy - 1]);
          if (cy < canvas.height - 1) stack.push([cx, cy + 1]);
        }
      }
      ctx.putImageData(imgData, 0, 0);
    }

    function matchStartColor(idx, startColor, data) {
      return (
        data[idx] === startColor[0] &&
        data[idx + 1] === startColor[1] &&
        data[idx + 2] === startColor[2] &&
        data[idx + 3] === startColor[3]
      );
    }

    function colorsMatch(a, b) {
      return a[0] === b[0] && a[1] === b[1] && a[2] === b[2] && a[3] === b[3];
    }

    // 🔄 Botón limpiar (volver imagen original)
    clearBtn.addEventListener("click", () => {
      if (originalImage) {
        ctx.putImageData(originalImage, 0, 0);
      }
    });

    // 🔗 Generar link
    generateLinkBtn.addEventListener("click", () => {
      if (loadedImages.length < 3) {
        alert("Debes cargar 3 imágenes antes de generar el link.");
        return;
      }
      const params = loadedImages.map(img => img.src).join("|||");
      const url = `${window.location.origin}${window.location.pathname}?imgs=${encodeURIComponent(params)}`;
      linkOutput.value = url;
    });

    // 🌐 Si hay imágenes en el link, cargarlas
    window.onload = () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has("imgs")) {
        const imgs = decodeURIComponent(params.get("imgs")).split("|||");
        imagesContainer.innerHTML = "";
        loadedImages = [];
        imgs.forEach((src, index) => {
          const img = new Image();
          img.src = src;
          img.onload = () => {
            loadedImages.push(img);
            const imgElement = document.createElement("img");
            imgElement.src = src;
            imgElement.dataset.index = index;
            imgElement.addEventListener("click", () => selectImage(index));
            imagesContainer.appendChild(imgElement);
          };
        });
      }
    };
  </script>
</body>
</html>
