<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Paint por N√∫meros</title>
  <style>
    body { 
      font-family: Arial, Comics Sans; 
      background: #f4f6f8; 
      margin: 0; 
      display: flex; 
      height: 100vh;
    }
    #sidebar {
      width: 240px;
      background: #fff;
      border-right: 2px solid #ccc;
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    #gallery {
      width: 200px;
      background: #fff;
      border-left: 2px solid #ccc;
      padding: 15px;
      box-sizing: border-box;
      overflow-y: auto;
      text-align: center;
    }
    #main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    h1 { font-size: 20px; margin-bottom: 15px; text-align: center; }
    #controls { margin-bottom: 20px; text-align: center; }
    #controls button, #controls input {
      display: block;
      margin: 8px auto;
      padding: 6px 10px;
      cursor: pointer;
      border: none;
      background: #4a90e2;
      color: white;
      border-radius: 4px;
      font-size: 14px;
    }
    #controls button:hover { background: #357ABD; }
    #palette { 
      display: grid; 
      grid-template-columns: repeat(5, 1fr); 
      gap: 5px; 
      justify-items: center;
    }
    #palette button { 
      width: 28px; 
      height: 28px; 
      border: 2px solid #222; 
      cursor: pointer; 
    }
    #selectedColor {
      margin-top: 15px; 
      text-align: center; 
      font-weight: bold; 
    }
    #selectedColor span {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 1px solid #000;
      vertical-align: middle;
    }
    #canvas { 
      border: 2px solid #333; 
      background: #fff; 
      cursor: crosshair; 
      max-width: 100%;
    }
    .thumb {
      width: 100%;
      margin: 10px 0;
      border: 2px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s, border 0.2s;
    }
    .thumb:hover {
      transform: scale(1.05);
      border: 2px solid #4a90e2;
    }
    #docentePanel { margin-top: 15px; text-align: center; }
    #felicitaciones {
      display: none;
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #4CAF50;
      color: white;
      padding: 20px 30px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h1>Paint por N√∫meros</h1>

    <div id="controls">
      <button onclick="resetCanvas()">üîÑ Limpiar</button>
      <button onclick="undo()">‚Ü©Ô∏è Deshacer</button>
      <button onclick="downloadImage()">‚¨áÔ∏è Descargar</button>
      <button onclick="toggleDocente()">üéì Modo Docente</button>
    </div>

    <div id="docentePanel" style="display:none;">
      <p>Sube 3 im√°genes:</p>
      <input type="file" id="img1" accept=".png,.jpg,.jpeg" />
      <input type="file" id="img2" accept=".png,.jpg,.jpeg" />
      <input type="file" id="img3" accept=".png,.jpg,.jpeg" />
      <button onclick="generarLink()">Generar Link</button>
      <p id="linkGenerado"></p>
    </div>

    <h3>üé® Paleta</h3>
    <div id="palette"></div>
    <div id="selectedColor">Color actual: <span id="colorBox"></span></div>
  </div>

  <div id="main">
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>

  <div id="gallery">
    <h3>Elige una imagen</h3>
    <div id="galleryImgs"></div>
  </div>

  <div id="felicitaciones">üéâ ¬°Felicitaciones, terminaste tu pintura! üëè</div>
  <audio id="aplausos" src="https://www.soundjay.com/human/applause-01.mp3"></audio>

<script>
/* ---------- Config ---------- */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let currentColor = 'red';
let currentImage = null; 
let originalImage = null;
const colorBox = document.getElementById('colorBox');
let history = []; 
const MAX_HISTORY = 10;

// Colores
const colors = [
  'red','crimson','firebrick','salmon','lightcoral',
  'orange','darkorange','coral','tomato','chocolate',
  'gold','yellow','khaki','lightyellow','beige',
  'lime','green','darkgreen','seagreen','olive',
  'cyan','skyblue','deepskyblue','blue','navy',
  'violet','orchid','plum','purple','indigo',
  'pink','hotpink','deeppink','palevioletred','magenta',
  'brown','sienna','peru','gray','dimgray',
  'black','white','silver','lightgray'
];
const palette = document.getElementById('palette');
colorBox.style.background = currentColor;
colors.forEach(c => {
  const btn = document.createElement('button');
  btn.style.background = c;
  btn.title = c;
  btn.onclick = () => { currentColor = c; colorBox.style.background = c; };
  palette.appendChild(btn);
});

/* ---------- Historial ---------- */
function saveState() {
  if (history.length >= MAX_HISTORY) history.shift(); 
  history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
}
function undo() {
  if (history.length > 0) {
    const prev = history.pop();
    ctx.putImageData(prev, 0, 0);
  }
}

/* ---------- Dibujar imagen base ---------- */
function drawBaseImage(img){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  originalImage = img;
  saveState();
}

/* ---------- Pintar ---------- */
canvas.addEventListener('click', e => {
  if (!originalImage) return; 
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor(e.clientX - rect.left);
  const y = Math.floor(e.clientY - rect.top);
  saveState();
  floodFill(x, y, currentColor, 40); 
  checkCompletion();
});

function floodFill(startX, startY, fillColor, tolerance = 40) {
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  const i = (startY * canvas.width + startX) * 4;
  const targetColor = [data[i], data[i+1], data[i+2], data[i+3]];
  const [fr, fg, fb, fa] = colorToRGBA(fillColor);

  const visited = new Uint8Array(canvas.width * canvas.height);
  const stack = [[startX, startY]];

  while (stack.length) {
    const [x, y] = stack.pop();
    if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;

    const idx = (y * canvas.width + x) * 4;
    const vidx = y * canvas.width + x;
    if (visited[vidx]) continue;
    visited[vidx] = 1;

    const r = data[idx], g = data[idx+1], b = data[idx+2], a = data[idx+3];
    if (colorsClose(r, g, b, a, ...targetColor, tolerance)) {
      data[idx] = fr;
      data[idx+1] = fg;
      data[idx+2] = fb;
      data[idx+3] = fa;
      stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
    }
  }
  ctx.putImageData(imageData, 0, 0);
}

function colorsClose(r1,g1,b1,a1, r2,g2,b2,a2, tolerance) {
  return (
    Math.abs(r1-r2)<=tolerance &&
    Math.abs(g1-g2)<=tolerance &&
    Math.abs(b1-b2)<=tolerance
  );
}
function colorToRGBA(color) {
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = 1;
  tempCanvas.height = 1;
  const tempCtx = tempCanvas.getContext('2d');
  tempCtx.fillStyle = color;
  tempCtx.fillRect(0, 0, 1, 1);
  return [...tempCtx.getImageData(0,0,1,1).data];
}

/* ---------- Limpiar y descargar ---------- */
function resetCanvas(){
  if (originalImage){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
    history = [];
    saveState();
  }
}
function downloadImage(){
  const link = document.createElement('a');
  link.download = 'pintado.png';
  link.href = canvas.toDataURL();
  link.click();
}

/* ---------- Modo Docente ---------- */
function toggleDocente(){
  const panel = document.getElementById('docentePanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}
function generarLink(){
  const files = [document.getElementById('img1').files[0],
                 document.getElementById('img2').files[0],
                 document.getElementById('img3').files[0]];
  if (files.some(f => !f)) { alert("Sube las 3 im√°genes"); return; }

  const readers = files.map(f => new Promise(resolve => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.readAsDataURL(f);
  }));
  Promise.all(readers).then(results => {
    const url = window.location.origin + window.location.pathname + "?imgs=" + encodeURIComponent(results.join('|'));
    document.getElementById('linkGenerado').innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
  });
}

/* ---------- Cargar desde link (modo alumno) ---------- */
window.onload = function(){
  const params = new URLSearchParams(window.location.search);
  if (params.has("imgs")){
    document.getElementById('docentePanel').style.display="none";
    document.querySelector('button[onclick="toggleDocente()"]').style.display="none";

    const urls = decodeURIComponent(params.get("imgs")).split('|');
    const gallery = document.getElementById('galleryImgs');
    gallery.innerHTML = "";
    urls.forEach(u=>{
      const img = document.createElement('img');
      img.src = u;
      img.className="thumb";
      img.onclick = ()=> elegirImagen(img, urls);
      gallery.appendChild(img);
    });
  }
};
function elegirImagen(img, urls){
  const thumbs = document.querySelectorAll('.thumb');
  thumbs.forEach(t=>{ if (t!==img) t.style.pointerEvents="none"; });
  const base = new Image();
  base.onload = ()=> drawBaseImage(base);
  base.src = img.src;
}

/* ---------- Detectar 98% completado ---------- */
function checkCompletion(){
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  let total = canvas.width * canvas.height;
  let blancos = 0;
  for (let i=0;i<imageData.length;i+=4){
    if (imageData[i]>240 && imageData[i+1]>240 && imageData[i+2]>240){ blancos++; }
  }
  let porcentaje = ((total-blancos)/total)*100;
  if (porcentaje>=98){
    document.getElementById('felicitaciones').style.display="block";
    document.getElementById('aplausos').play();
  }
}
</script>
</body>
</html>
